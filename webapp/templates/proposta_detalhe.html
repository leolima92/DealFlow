{% extends "base.html" %}
{% block title %}Proposta #{{ proposta.id }} - Deal Flow{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Proposta #{{ proposta.id }}</h1>
  <a href="{{ url_for('ui.listar_propostas') }}" class="btn btn-secondary btn-sm">
    Voltar
  </a>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-6">
    <div class="card bg-black text-light border-secondary h-100">
      <div class="card-body">
        <h5 class="card-title">{{ proposta.titulo }}</h5>
        <p class="mb-1"><strong>Cliente:</strong> {{ proposta.cliente.nome }}</p>
        <p class="mb-1"><strong>Status:</strong> {{ proposta.status }}</p>
        <p class="mb-1">
          <strong>Abertura:</strong> {{ proposta.data_criacao.strftime("%d/%m/%Y") }}
        </p>
        <p class="mb-1">
          <strong>Validade:</strong>
          {% if proposta.validade %}
            {{ proposta.validade.strftime("%d/%m/%Y") }}
          {% else %}-{% endif %}
        </p>
        <p class="mb-1"><strong>Responsável:</strong> {{ proposta.responsavel or "-" }}</p>
        <p class="mb-0">
          <strong>Condições de pagamento:</strong>
          {{ proposta.condicoes_pagamento or "-" }}
        </p>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card bg-black text-light border-secondary h-100">
      <div class="card-body">
        <h5 class="card-title">Resumo financeiro</h5>
        <p class="mb-1">
          <strong>Subtotal:</strong>
          R$ {{ "%.2f"|format(proposta.calcular_subtotal()) }}
        </p>
        <p class="mb-1">
          <strong>Desconto:</strong>
          {% if proposta.tipo_desconto == "%" %}
            {{ "%.2f"|format(proposta.desconto_percentual) }}%
          {% elif proposta.tipo_desconto == "R" %}
            R$ {{ "%.2f"|format(proposta.desconto_valor) }}
          {% else %}
            -
          {% endif %}
        </p>
        <p class="mb-3">
          <strong>Total:</strong>
          R$ {{ "%.2f"|format(proposta.calcular_total()) }}
        </p>

        <h6 class="mb-2">Alterar status</h6>
        <form method="post" action="{{ url_for('ui.alterar_status', proposta_id=proposta.id) }}" class="row g-2 mb-3">
          <div class="col-8">
            <select name="status" class="form-select form-select-sm">
              {% for st in proposta.STATUS_VALIDOS %}
                <option value="{{ st }}" {% if proposta.status == st %}selected{% endif %}>
                  {{ st }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-4">
            <button class="btn btn-outline-light btn-sm w-100" type="submit">Atualizar</button>
          </div>
        </form>

        <h6 class="mb-2">Desconto</h6>
        <form method="post" action="{{ url_for('ui.aplicar_desconto', proposta_id=proposta.id) }}" class="row g-2">
          <div class="col-4">
            <select name="tipo" class="form-select form-select-sm">
              <option value="nenhum">Nenhum</option>
              <option value="%" {% if proposta.tipo_desconto == "%" %}selected{% endif %}>Percentual</option>
              <option value="R" {% if proposta.tipo_desconto == "R" %}selected{% endif %}>Valor</option>
            </select>
          </div>
          <div class="col-4">
            <input type="text" name="valor" class="form-control form-control-sm"
                   placeholder="0,00">
          </div>
          <div class="col-4">
            <button class="btn btn-outline-light btn-sm w-100" type="submit">Aplicar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<h2 class="h5 mb-2">Itens da proposta</h2>
{% if proposta.itens %}
  <div class="table-responsive">
    <table class="table table-dark table-sm align-middle">
      <thead>
        <tr>
          <th>Descrição</th>
          <th style="width: 80px;">Qtd</th>
          <th style="width: 130px;">Unitário (R$)</th>
          <th style="width: 130px;">Total (R$)</th>
        </tr>
      </thead>
      <tbody>
        {% for item in proposta.itens %}
          <tr>
            <td>{{ item.descricao }}</td>
            <td>{{ item.quantidade }}</td>
            <td>{{ "%.2f"|format(item.valor_unitario) }}</td>
            <td>{{ "%.2f"|format(item.total) }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <p class="text-muted">Nenhum item cadastrado para esta proposta.</p>
{% endif %}

{% endblock %}
